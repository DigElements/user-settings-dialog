<!--
Copyright 2017 Next Century Corporation

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../button-action/button-action.html">
<link rel="import" href="../fontawesome-iconset/fa-all.html">
<link rel="import" href="../iron-collapse/iron-collapse.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-icons/social-icons.html">
<link rel="import" href="../lodash-import/lodash.html">
<link rel="import" href="../modal-icon/modal-icon.html">
<link rel="import" href="../moment-element/moment-with-locales-import.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../paper-styles/color.html">
<link rel="import" href="../paper-styles/shadow.html">
<link rel="import" href="../styled-dialog/styled-dialog.html">
<link rel="import" href="../styled-dialog/styled-dialog-styles.html">
<link rel="import" href="../terms-display/terms-display.html">

<!--
A Polymer Element showing a button that opens a dialog with user settings.

### Example
```js
var buildStateDataFunction = function(state) {
  return {
    date: state.date || [],
    list: state.list || []
  };
};

var buildPopupDataFunction = function(state) {
  return {
    'Start': state.date && state.date.length === 2 && state.date[0] ? [state.date[0]] : [],
    'End': state.date && state.date.length === 2 && state.date[1] ? [state.date[1]] : [],
    'Data': state.list
  };
};

var resetDatesDataFunction = function(state, start, end) {
  return {
    date: (start || end) ? [start, end] : state.date,
    list: state.list
  };
};

var cases = [{
  name: 'Case #1',
  entityList: [],
  resultList: [],
  searchList: [],
  sendEmailAlert: false
}, {
  name: 'Case #2',
  entityList: [],
  resultList: [],
  searchList: [{
    lastAutomatedRun: new Date('01-05-2017'),
    lastViewedByUser: new Date('01-01-2017'),
    notify: false,
    uiState: '{\"networkExpansion\":{},\"search\":{\"fieldA\": [\"value0\"]}}'
  }],
  sendEmailAlert: false
}, {
  name: 'Case #3',
  entityList: [{
    id: 'entity1',
    name: 'Entity #1',
    type: 'type1'
  }],
  resultList: [{
    id: 'result1',
    name: 'Result #1',
    type: 'type5'
  }],
  searchList: [{
    lastAutomatedRun: new Date('01-05-2017'),
    lastViewedByUser: new Date('01-02-2017'),
    notify: true,
    uiState: '{\"networkExpansion\":{},\"search\":{\"date\": [\"01-01-2017\", null], \"fieldB\": [\"value1\"], \"fieldC\": [\"value2\"], \"fieldD\": [\"value3\"]}}'
  }],
  sendEmailAlert: true
}, {
  name: 'Case #4',
  entityList: [{
    id: 'entity2',
    name: 'Entity #2',
    type: 'type2'
  }, {
    id: 'entity3',
    name: 'Entity #3',
    type: 'type3'
  }],
  resultList: [{
    id: 'result2',
    name: 'Result #2',
    type: 'type5'
  }, {
    id: 'result3',
    name: 'Result #3',
    type: 'type5'
  }],
  searchList: [{
    lastAutomatedRun: new Date('01-05-2017'),
    lastViewedByUser: new Date('01-03-2017'),
    notify: false,
    uiState: '{\"networkExpansion\":{},\"search\":{\"fieldA\": [\"value4\"], \"fieldB\": [\"value5\"]}}'
  }, {
    lastAutomatedRun: new Date('01-05-2017'),
    lastViewedByUser: new Date('01-04-2017'),
    notify: true,
    uiState: '{\"networkExpansion\":{},\"search\":{\"date\": [\"01-01-2017\", \"01-29-2017\"], \"fieldC\": [\"value6\", \"value7\"], \"fieldD\": [\"value8\", \"value9\"]}}'
  }],
  sendEmailAlert: true
}];

var linkFunction = function(id) {
  return 'http://' + id;
};

var dataConfig = {
  type1: {
    icon: 'bookmark',
    link: linkFunction,
    name: 'Type #1',
    styleClass: 'class1'
  },
  type2: {
    icon: 'favorite',
    link: linkFunction,
    name: 'Type #2',
    styleClass: 'class2'
  },
  type3: {
    icon: 'star',
    link: linkFunction,
    name: 'Type #3',
    styleClass: 'class3'
  },
  type4: {
    icon: 'face',
    link: linkFunction,
    name: 'Type #4',
    styleClass: 'class4'
  },
  type5: {
    icon: 'assignment',
    link: linkFunction,
    name: 'Type #5',
    styleClass: 'class5'
  }
};
```

```html
<user-settings-dialog
  build-state-data-function="[[buildStateDataFunction]]"
  build-terms-data-function="[[buildPopupDataFunction]]"
  reset-dates-data-function="[[resetDatesDataFunction]]"
  enable-email-address
  enable-search
  cases="[[cases]]"
  entity-config="[[dataConfig]]"
  function-config="[[functionConfig]]"
  result-link-function="[[linkFunction]]"
  user-id="1234"
  username="demo_user"
  blur-images="{{blurImages}}"
  email-address="{{emailAddress}}"
  network-expansion-parameters="{{networkExpansionParameters}}"
  notifications="{{notifications}}"
  notification-date="{{notificationDate}}"
  notification-interval="{{notificationInterval}}"
  search-parameters="{{searchParameters}}">
</user-settings-dialog>
```

@demo demo/index.html
-->

<dom-module id="user-settings-dialog">
  <template>
    <style include="iron-flex iron-flex-alignment"></style>
    <style include="styled-dialog-styles"></style>
    <style>
      :host {
        display: inline-block;
      }

      iron-icon {
        height: 20px;
        width: 20px;
        min-width: 20px;
        margin-right: 10px;
      }

      paper-icon-button {
        border-radius: 50%;
        height: 30px;
        width: 30px;
        min-width: 30px;
        margin-right: 10px;
        padding: 5px;
      }

      #settingsButton {
        margin-left: 10px;
        margin-right: 0;
        padding: 0;
      }

      .highlight-background {
        background-color: greenyellow;
      }

      .highlight-foreground {
        color: greenyellow;
      }

      .notification-button {
        color: var(--secondary-text-color);
      }

      .active {
        color: var(--primary-text-color);
      }

      paper-icon-button:not(#settingsButton):hover {
        color: black;
      }

      .case-item {
        box-shadow: var(--shadow-elevation-4dp);
        padding: 10px;
      }

      .case-item:hover .case-info,
      .case-item.expand .case-info {
        background-color: yellow;
        cursor: pointer;
      }

      .case-item .styled-dialog-divider {
        border-color: var(--secondary-text-color);
      }

      .case-data-info {
        margin-left: 80px;
        margin-top: 5px;
      }

      .case-data-item {
        margin-top: 10px;
        margin-left: 40px;
      }

      paper-dropdown-menu,
      paper-input {
        --paper-input-container: {
          padding: 4px 0 0;
        };
      }

      paper-input {
        /* Match the width of the dropdown menu. */
        width: 225px;
      }

      paper-listbox {
        --paper-listbox: {
          padding: 0;
        };
      }

      paper-listbox paper-item {
        --paper-item-min-height: 30px;
        --paper-item: {
          cursor: pointer;
          padding: 0 10px;
          white-space: nowrap;
        };
      }

      .pointer {
        cursor: pointer;
      }

      .set-width {
        width: 175px;
      }

      button-action {
        margin: 10px 10px 0 10px;
      }

      modal-icon {
        --paper-icon-button: {
          border-radius: 50%;
          height: 30px;
          width: 30px;
          min-width: 30px;
          margin-right: 10px;
          padding: 5px;
        };
      }

      iron-icon.amber {
        color: var(--paper-amber-600);
      }

      iron-icon.black {
        color: #111;
      }

      iron-icon.blue {
        color: var(--paper-blue-600);
      }

      iron-icon.blue-grey {
        color: var(--paper-blue-grey-600);
      }

      iron-icon.brown {
        color: var(--paper-brown-600);
      }

      iron-icon.cyan {
        color: var(--paper-cyan-600);
      }

      iron-icon.deep-orange {
        color: var(--paper-deep-orange-600);
      }

      iron-icon.deep-purple {
        color: var(--paper-deep-purple-600);
      }

      iron-icon.green {
        color: var(--paper-green-600);
      }

      iron-icon.grey {
        color: var(--paper-grey-600);
      }

      iron-icon.indigo {
        color: var(--paper-indigo-600);
      }

      iron-icon.light-blue {
        color: var(--paper-light-blue-600);
      }

      iron-icon.light-green {
        color: var(--paper-light-green-600);
      }

      iron-icon.lime {
        color: var(--paper-lime-600);
      }

      iron-icon.orange {
        color: var(--paper-orange-600);
      }

      iron-icon.pink {
        color: var(--paper-pink-600);
      }

      iron-icon.purple {
        color: var(--paper-purple-600);
      }

      iron-icon.red {
        color: var(--paper-red-600);
      }

      iron-icon.teal {
        color: var(--paper-teal-600);
      }

      iron-icon.white {
        color: #fff;
      }

      iron-icon.yellow {
        color: var(--paper-yellow-600);
      }
    </style>

    <paper-icon-button
      id="settingsButton"
      class$="[[_getSettingsButtonStyleClass(enableSearch, notifications)]]"
      icon="fa:cog"
      title$="[[_getSettingsButtonText(notifications)]]"
      on-tap="_openSettingsDialog">
    </paper-icon-button>

    <styled-dialog id="settingsDialog" header="User Settings" fill>
      <div class="layout horizontal center">
        <div class="start-justified flex">
          <span class="styled-dialog-text styled-dialog-right-space">Logged in as <span class="styled-dialog-strong">[[username]]</span></span>
        </div>
        <div class="end-justified">
          <span class="styled-dialog-text styled-dialog-right-space">DIG Version <span class="styled-dialog-strong">DIG_VERSION</span></span>
        </div>
      </div>

      <div class="styled-dialog-divider"></div>

      <template is="dom-if" if="[[userLoading]]">
        <span class="styled-dialog-text styled-dialog-right-space">Loading User Settings...</span>
      </template>

      <template is="dom-if" if="[[!userLoading]]">
        <template is="dom-if" if="[[userId]]" restamp="true">
          <div class="layout horizontal center">
            <span class="pointer styled-dialog-text styled-dialog-strong styled-dialog-right-space" on-tap="_toggleBlur">Blur Images</span>
            <paper-icon-button icon="[[_getCheckboxIcon(blurImages, userId)]]" title="Toggle Blur Images" on-tap="_toggleBlur"></paper-icon-button>
          </div>

          <template is="dom-if" if="[[enableEmailAddress]]">
            <div class="layout horizontal center">
              <span class="set-width styled-dialog-text styled-dialog-strong">Email Address for Alerts</span>
              <paper-input class="styled-dialog-right-space" label="Enter Email Address" value="{{_emailInput}}" no-label-float type="email" auto-validate invalid="{{_isEmailInvalid}}"></paper-input>
              <paper-icon-button disabled="[[_getEmailAddressButtonIsDisabled(_emailInput, _isEmailInvalid)]]" icon="fa:floppy-o" title="Save Email Address" on-tap="_saveEmailAddress"></paper-icon-button>
            </div>
          </template>

          <div class="layout horizontal center">
            <span class="set-width styled-dialog-text styled-dialog-strong">Check Cases for New Data</span>
            <paper-dropdown-menu class="styled-dialog-right-space" label="Interval" no-label-float>
              <paper-listbox slot="dropdown-content" attr-for-selected="value" selected="{{notificationInterval}}">
                <paper-item value="never">Never</paper-item>
                <paper-item value="daily">Every Day</paper-item>
                <paper-item value="weekly">Every Week</paper-item>
              </paper-listbox>
            </paper-dropdown-menu>
          </div>

          <div class="styled-dialog-divider"></div>

          <div class="styled-dialog-text styled-dialog-strong">Saved Cases</div>

          <div class="layout vertical case-list">
            <template is="dom-if" if="[[cases]]">
              <div class="styled-dialog-divider"></div>

              <template is="dom-repeat" items="[[cases]]" as="case" index-as="caseIndex">
                <div class$="layout vertical case-item [[_getCaseStyleClass(caseIndex, _collapsedCases)]]">
                  <div class="layout horizontal center case-info" title$="[[_getCaseTitleTooltip(caseIndex, _collapsedCases)]]" on-tap="_toggleCase">
                    <modal-icon open="[[!_isInList(caseIndex, _collapsedCases)]]" openable></modal-icon>

                    <paper-icon-button
                      class$="notification-button [[_getNotificationButtonStyleClass(notificationInterval, case.sendEmailAlert)]]"
                      icon$="[[_getNotificationButtonIcon(notificationInterval, case.sendEmailAlert)]]"
                      title="[[_getNotificationButtonText(notificationInterval, case.sendEmailAlert)]]"
                      on-tap="_toggleEmailAlert">
                    </paper-icon-button>

                    <paper-icon-button
                      icon="fa:trash"
                      title="Delete Saved Case"
                      on-tap="_openDeleteCaseDialog">
                    </paper-icon-button>

                    <div class="styled-dialog-text styled-dialog-strong styled-dialog-right-space case-name">[[case.name]]</div>
                  </div>

                  <iron-collapse opened="[[!_isInList(caseIndex, _collapsedCases)]]">
                    <template is="dom-repeat" items="[[case.searchList]]" as="search" index-as="searchIndex">
                      <div class="layout vertical case-data-item">
                        <div class="layout horizontal center">
                          <paper-icon-button
                            case$="[[caseIndex]]"
                            class$="[[_getViewButtonStyleClass(search.notify, enableSearch)]]"
                            icon="fa:search"
                            title$="[[_getRunButtonText(enableSearch, search.notify)]]"
                            on-tap="_runSearch"
                            disabled="[[!enableSearch]]">
                          </paper-icon-button>

                          <paper-icon-button
                            icon="fa:trash"
                            title="Delete Saved Search"
                            on-tap="_openDeleteCaseDataDialog">
                          </paper-icon-button>

                          <terms-display
                            collection="[[_getTermsDisplayCollection(search.uiState, functionConfig)]]"
                            label="">
                          </terms-display>
                        </div>

                        <div class="layout horizontal center case-data-info">
                          <div class="styled-dialog-note styled-dialog-right-space">You Last Ran on [[_formatDate(search.lastViewedByUser)]]</div>
                          <div class="styled-dialog-right-space"> |</div>
                          <div class="styled-dialog-note styled-dialog-right-space">DIG Last Checked on [[_formatDate(search.lastAutomatedRun)]]</div>
                        </div>
                      </div>
                    </template>

                    <template is="dom-repeat" items="[[case.entityList]]" as="entity" index-as="entityIndex">
                      <div class="layout vertical case-data-item">
                        <div class="layout horizontal center">
                          <paper-icon-button
                            case$="[[caseIndex]]"
                            class$="[[_getViewButtonStyleClass(entity.notify, 'true')]]"
                            icon="fa:external-link-square"
                            title$="[[_getOpenPageButtonText(entity.notify, entity.type, dataConfig, 'Entity')]]"
                            on-tap="_openPage">
                          </paper-icon-button>

                          <paper-icon-button
                            icon="fa:trash"
                            title="Delete Saved [[_getProperty(dataConfig, entity.type, 'name')]]"
                            on-tap="_openDeleteCaseDataDialog">
                          </paper-icon-button>

                          <iron-icon
                            class$="[[_getProperty(dataConfig, entity.type, 'styleClass')]]"
                            icon="[[_getProperty(dataConfig, entity.type, 'icon')]]"
                            title$="[[_getProperty(dataConfig, entity.type, 'name')]]">
                          </iron-icon>

                          <div class="styled-dialog-text">[[entity.name]]</div>
                        </div>

                        <div class="layout horizontal center case-data-info">
                          <div class="styled-dialog-note styled-dialog-right-space">You Last Viewed on [[_formatDate(entity.lastViewedByUser)]]</div>
                          <div class="styled-dialog-right-space"> |</div>
                          <div class="styled-dialog-note styled-dialog-right-space">DIG Last Checked on [[_formatDate(entity.lastAutomatedRun)]]</div>
                        </div>
                      </div>
                    </template>

                    <template is="dom-repeat" items="[[case.resultList]]" as="result" index-as="resultIndex">
                      <div class="layout vertical case-data-item">
                        <div class="layout horizontal center">
                          <paper-icon-button
                            case$="[[caseIndex]]"
                            class$="[[_getViewButtonStyleClass(result.notify, 'true')]]"
                            icon="fa:external-link-square"
                            title$="[[_getOpenPageButtonText(result.notify, result.type, dataConfig, 'Result')]]"
                            on-tap="_openPage">
                          </paper-icon-button>

                          <paper-icon-button
                            icon="fa:trash"
                            title="Delete Saved [[_getProperty(dataConfig, result.type, 'name')]]"
                            on-tap="_openDeleteCaseDataDialog">
                          </paper-icon-button>

                          <iron-icon
                            class$="[[_getProperty(dataConfig, result.type, 'styleClass')]]"
                            icon="[[_getProperty(dataConfig, result.type, 'icon')]]"
                            title$="[[_getProperty(dataConfig, result.type, 'name')]]">
                          </iron-icon>

                          <div class="styled-dialog-text">[[result.name]]</div>
                        </div>

                        <div class="layout horizontal center case-data-info">
                          <div class="styled-dialog-note styled-dialog-right-space">You Last Viewed on [[_formatDate(result.lastViewedByUser)]]</div>
                          <div class="styled-dialog-right-space"> |</div>
                          <div class="styled-dialog-note styled-dialog-right-space">DIG Last Checked on [[_formatDate(result.lastAutomatedRun)]]</div>
                        </div>
                      </div>
                    </template>
                  </iron-collapse>
                </div>

                <div class="styled-dialog-divider"></div>
              </template>
            </template>
          </div>
        </template>

        <template is="dom-if" if="[[!userId]]" restamp="true">
          <div class="styled-dialog-text">Waiting on New User Profile...</div>
        </template>
      </template>
    </styled-dialog>

    <styled-dialog id="deleteCaseDialog" modal>
      <div class="styled-dialog-bold">Are you sure you want to delete this case?</div>
      <div class="layout horizontal center-justified">
        <button-action dialog-confirm class="styled-dialog-button" text="OK" click-listener="[[_createDeleteCaseListener()]]"></button-action>
        <button-action dialog-dismiss class="styled-dialog-button" text="Cancel"></button-action>
      </div>
    </styled-dialog>

    <styled-dialog id="deleteCaseDataDialog" modal>
      <div class="styled-dialog-bold">Are you sure you want to delete this [[_deleteCaseDataLabel]]?</div>
      <div class="layout horizontal center-justified">
        <button-action dialog-confirm text="OK" click-listener="[[_createDeleteCaseDataListener()]]"></button-action>
        <button-action dialog-dismiss text="Cancel"></button-action>
      </div>
    </styled-dialog>
  </template>

  <script>
  (function() {
    /* globals _, moment */
    'use strict';

    Polymer({
      is: 'user-settings-dialog',

      properties: {
        /**
         * (Optional|Output)
         *
         * Whether to blur images for the user.
         *
         * @type {Boolean}
         */
        blurImages: {
          notify: true,
          type: Boolean
        },

        /**
         * (Required)
         *
         * The function to build the terms-display data in the popup using a saved state object.
         * Must return an object containing fields mapped to arrays of string values.
         *
         * @type {Object}
         */
        buildPopupDataFunction: {
          type: Object
        },

        /**
         * (Required)
         *
         * The function to build the search parameters using a saved state object.
         *
         * @type {Object}
         */
        buildStateDataFunction: {
          type: Object
        },

        /**
         * (Required|Output)
         *
         * The saved cases for the user.
         *
         * @type {Array}
         */
        cases: {
          notify: true,
          observer: '_updateNotifications',
          type: Array
        },

        /**
         * (Required)
         *
         * The config object for the entities in the saved cases containing entity types mapped to objects containing {String} icon, {Function} link, {String} name, and {String} styleClass.
         *
         * @type {Object}
         */
        dataConfig: {
          type: Object
        },

        /**
         * (Optional|Output)
         *
         * The email address for the user.
         *
         * @type {String}
         */
        emailAddress: {
          notify: true,
          observer: '_updateEmailInput',
          type: String
        },

        /**
         * (Optional)
         *
         * Whether to let the user input an email address.
         *
         * @type {Boolean}
         * @default false
         */
        enableEmailAddress: {
          type: Boolean,
          value: false
        },

        /**
         * (Optional)
         *
         * Whether to let the user run searches.
         *
         * @type {Boolean}
         * @default false
         */
        enableSearch: {
          type: Boolean,
          value: false
        },

        /**
         * (Required to save search)
         *
         * The config object for the build function.
         *
         * @type {Object}
         */
        functionConfig: {
          type: Object
        },

        /**
         * (Optional|Output)
         *
         * The network expansion parameters.
         *
         * @type {Object}
         */
        networkExpansionParameters: {
          notify: true,
          type: Object
        },

        /**
         * (Optional|Output)
         *
         * Whether the user has notifications.
         *
         * @type {Boolean}
         * @default false
         */
        notifications: {
          notify: true,
          type: Boolean,
          value: false
        },

        /**
         * (Optional|Output)
         *
         * The notification interval for the user.
         *
         * @type {String}
         * @default 'never'
         */
        notificationInterval: {
          notify: true,
          type: String
        },

        /**
         * (Output)
         *
         * The notification date for the user.  Is set if the user runs a search with a notification using the date on which the user last viewed the search.
         *
         * @type {Object}
         */
        notificationDate: {
          notify: true,
          type: Object
        },

        /**
         * (Output)
         *
         * Whether to run new searches.
         *
         * @type {Boolean}
         */
        processRequest: {
          notify: true,
          type: Boolean
        },

        /**
         * (Required)
         *
         * The profile manager object used to save searches.  Must have the function "reloadUser".
         *
         * @param {Object}
         */
        profileManager: {
          type: Object
        },

        /**
         * (Required)
         *
         * The function to reset the dates in the saved search state object.  Arguments:  {Object} stateObject, {Date} startDate
         *
         * @type {Object}
         */
        resetDatesDataFunction: {
          type: Object
        },

        /**
         * (Required)
         *
         * The function to create and return the link for a given result ID.
         *
         * @type {Object}
         */
        resultLinkFunction: {
          type: Object
        },

        /**
         * (Optional|Output)
         *
         * The search parameters.
         *
         * @type {Object}
         */
        searchParameters: {
          notify: true,
          type: Object
        },

        /**
         * (Required)
         *
         * The name of the user.
         *
         * @type {String}
         */
        username: {
          type: String
        },

        /**
         * (Required)
         *
         * The unique ID of the user.
         *
         * @type {String}
         */
        userId: {
          type: String
        },

        /**
         * (Optional)
         *
         * Whether the user profile is loading.
         *
         * @type {Boolean}
         * @default false
         */
        userLoading: {
          type: Boolean,
          value: false
        },

        /**
         * The list of collapsed case indexes.
         *
         * @type {Array}
         * @default []
         * @private
         */
        _collapsedCases: {
          type: Array,
          value: function() {
            return [];
          }
        },

        /**
         * The index of the case to delete (or the index of the case with data to delete if `_deleteCaseDataIndex` is set).
         *
         * @type {Number}
         * @private
         */
        _deleteCaseIndex: {
          type: Number
        },

        /**
         * The array (searchList, resultList, entityList) of the data to delete (from the case at the index of `_deleteCaseIndex`).
         *
         * @type {Number}
         * @private
         */
        _deleteCaseDataArray: {
          type: String
        },

        /**
         * The index of the data to delete (from the case at the index of `_deleteCaseIndex`).
         *
         * @type {Number}
         * @private
         */
        _deleteCaseDataIndex: {
          type: Number
        },

        /**
         * The label of the data to delete (from the case at the index of `_deleteCaseIndex`).
         *
         * @type {Number}
         * @private
         */
        _deleteCaseDataLabel: {
          type: String
        },

        /**
         * The email input.
         *
         * @type {String}
         * @private
         */
        _emailInput: {
          type: String
        },

        /**
         * Whether the `searchParameters` are being set by `_runSearch`.  If so, do not reset the `notificationDate`.
         *
         * @type {Boolean}
         * @private
         */
        _handlingSearch: {
          type: Boolean
        },

        /**
         * Whether the email input is invalid.
         *
         * @type {Boolean}
         * @private
         */
        _isEmailInvalid: {
          type: Boolean
        }
      },

      observers: [
        '_deleteNotificationDate(searchParameters.*)',
      ],

      /**
       * Returns a `button-action` listener to delete the case at `_deleteCaseIndex`.
       *
       * @return {Object}
       * @private
       */
      _createDeleteCaseListener: function() {
        var self = this;
        return {
          onClick: function() {
            if(self._collapsedCases.indexOf(self._deleteCaseIndex) >= 0) {
              self.set('_collapsedCases', self._collapsedCases.filter(function(item) {
                return item !== self._deleteCaseIndex;
              }).map(function(item) {
                return item;
              }));
            }
            self.splice('cases', self._deleteCaseIndex, 1);
          }
        };
      },

      /**
       * Returns a `button-action` listener to delete the data at `_deleteCaseDataIndex` in the case at `_deleteCaseIndex`.
       *
       * @return {Object}
       * @private
       */
      _createDeleteCaseDataListener: function() {
        var self = this;
        return {
          onClick: function() {
            var caseItem = _.cloneDeep(self.cases[self._deleteCaseIndex]);
            caseItem[self._deleteCaseDataArray].splice(self._deleteCaseDataIndex, 1);
            self.splice('cases', self._deleteCaseIndex, 1, caseItem);
          }
        };
      },

      /**
       * Creates and returns a new object for the searchParameters using the given state.
       *
       * @param {String} stateString
       * @param {Object} functionConfig
       * @param {Date} lastViewedByUser
       * @return {Object}
       * @private
       */
      _createSearchParameters: function(stateString, functionConfig, lastViewedByUser) {
        var stateObject = stateString ? JSON.parse(stateString) : {};
        var searchParameters = this.buildStateDataFunction && stateObject ? this.buildStateDataFunction(stateObject.search || {}, functionConfig) : undefined;
        return (searchParameters && this.resetDatesDataFunction) ? this.resetDatesDataFunction(searchParameters, this._formatDate(lastViewedByUser)) : searchParameters;
      },

      /**
       * Deletes the `notificationDate` if not in the middle of `_runSearch` (if `_handlingSearch` is false).
       *
       * @private
       */
      _deleteNotificationDate: function() {
        if(!this._handlingSearch) {
          this.notificationDate = null;
        }
      },

      /**
       * Returns the formatted date string.
       *
       * @param {Date} date
       * @return {String}
       * @private
       */
      _formatDate: function(date) {
        return date ? moment.utc(new Date(date)).format('MMMM DD, YYYY') : '';
      },

      /**
       * Returns the style class for the case at the given index.
       *
       * @param {Number} caseIndex
       * @param {Array} collapsedCases
       * @return {String}
       * @private
       */
      _getCaseStyleClass: function(caseIndex, collapsedCases) {
        return this._isInList(caseIndex, collapsedCases) ? 'collapse' : 'expand';
      },

      /**
       * Returns the title tooltip for the case at the given index.
       *
       * @param {Number} caseIndex
       * @param {Array} collapsedCases
       * @return {String}
       * @private
       */
      _getCaseTitleTooltip: function(caseIndex, collapsedCases) {
        return this._isInList(caseIndex, collapsedCases) ? 'Click to Expand Case' : 'Click to Collapse Case';
      },

      /**
       * Returns the checkbox icon for the given status.
       *
       * @param {Boolean} checkboxStatus
       * @return {String}
       * @private
       */
      _getCheckboxIcon: function(checkboxStatus) {
        return checkboxStatus ? 'check-box' : 'check-box-outline-blank';
      },

      /**
       * Returns whether the 'save email address' button is disabled.
       *
       * @param {String} emailAddress
       * @param {Boolean} isEmailInvalid
       * @return {Boolean}
       * @private
       */
      _getEmailAddressButtonIsDisabled: function(emailAddress, isEmailInvalid) {
        return (!emailAddress) || isEmailInvalid;
      },

      /**
       * Returns the icon for the notification button with the given interval and status.
       *
       * @param {String} notificationInterval
       * @param {Boolean} notificationStatus
       * @return {String}
       * @private
       */
      _getNotificationButtonIcon: function(notificationInterval, notificationStatus) {
        return notificationInterval === 'never' || !notificationStatus ? 'social:notifications-off' : 'social:notifications-active';
      },

      /**
       * Returns the style class for the notification button with the given interval and status.
       *
       * @param {String} notificationInterval
       * @param {Boolean} notificationStatus
       * @return {String}
       * @private
       */
      _getNotificationButtonStyleClass: function(notificationInterval, notificationStatus) {
        return notificationInterval === 'never' || !notificationStatus ? '' : 'active';
      },

      /**
       * Returns the text for the notification button with the given interval and status.
       *
       * @param {String} notificationInterval
       * @param {Boolean} notificationStatus
       * @return {String}
       * @private
       */
      _getNotificationButtonText: function(notificationInterval, notificationStatus) {
        if(notificationInterval === 'never') {
          return 'Please choose a notification interval above to enable notifications on saved searches.';
        }
        return 'Notifications ' + (notificationStatus ? 'ON' : 'OFF') + ' (Click to Toggle ' + (notificationStatus ? 'OFF' : 'ON') + ')';
      },

      /**
       * Returns the text for the 'open entity page' button with the given settings.
       *
       * @param {Boolean} notify
       * @param {String} type
       * @param {Object} config
       * @param {String} defaultValue
       * @return {String}
       * @private
       */
      _getOpenPageButtonText: function(notify, type, config, defaultValue) {
        var string = config && config[type] ? config[type].name : '';
        return 'Open Saved ' + (string || defaultValue) + (notify ? ' (New Data Available)' : '');
      },

      /**
       * Returns the object in the given item at the given nested property.
       *
       * @param {Object} item
       * @param {String} property
       * @param {String} nestedProperty
       * @return {Object}
       * @private
       */
      _getProperty: function(item, property, nestedProperty) {
        return item && item[property] ? item[property][nestedProperty] : undefined;
      },

      /**
       * Returns the text for the 'run search' button with the given settings.
       *
       * @param {Boolean} enableSearch
       * @param {Boolean} notify
       * @return {String}
       * @private
       */
      _getRunButtonText: function(enableSearch, notify) {
        if(enableSearch) {
          return 'Please Return to Search Page to Run Saved Search';
        }
        return 'Run Saved Search' + (notify ? ' (New Data Available)' : '');
      },

      /**
       * Returns the style class for the settings button with the given settings.
       *
       * @param {Boolean} enableSearch
       * @param {Boolean} notifications
       * @return {String}
       * @private
       */
      _getSettingsButtonStyleClass: function(enableSearch, notifications) {
        return enableSearch && notifications ? 'highlight-foreground' : '';
      },

      /**
       * Returns the text for the settings button with the given status.
       *
       * @param {Boolean} notifications
       * @return {String}
       * @private
       */
      _getSettingsButtonText: function(notifications) {
        return 'Open User Settings' + (notifications ? ' (You Have Notifications)' : '');
      },

      /**
       * Returns the object for the `terms-display` using the given state.
       *
       * @param {String} stateString
       * @param {Object} functionConfig
       * @return {Object}
       * @private
       */
      _getTermsDisplayCollection: function(stateString, functionConfig) {
        var stateObject = stateString ? JSON.parse(stateString) : {};
        return this.buildPopupDataFunction && stateObject ? this.buildPopupDataFunction(stateObject.search || {}, functionConfig) : undefined;
      },

      /**
       * Returns the style class for the 'run search' or 'open page' button with the given settings.
       *
       * @param {Boolean} notify
       * @param {Boolean} enable
       * @return {String}
       * @private
       */
      _getViewButtonStyleClass: function(notify, enable) {
        return notify && enable ? 'highlight-background' : '';
      },

      /**
       * Returns whether the given item is in the given list.
       *
       * @param {Object} item
       * @param {Array} list
       * @return {Boolean}
       * @private
       */
      _isInList: function(item, list) {
        return (list.indexOf(item) >= 0);
      },

      /**
       * Opens the 'delete case' dialog.
       *
       * @param {Event} event
       * @private
       */
      _openDeleteCaseDialog: function(event) {
        this._deleteCaseIndex = event.model.caseIndex;
        this.$$('#deleteCaseDialog').open();
      },

      /**
       * Opens the 'delete search' dialog.
       *
       * @param {Event} event
       * @private
       */
      _openDeleteCaseDataDialog: function(event) {
        var array = '';
        var index = -1;
        var label = '';

        if(event.model.searchIndex >= 0) {
          array = 'searchList';
          index = event.model.searchIndex;
          label = 'search';
        }
        if(event.model.entityIndex >= 0) {
          array = 'entityList';
          index = event.model.entityIndex;
          label = (this.dataConfig && this.dataConfig[event.model.entity.type] ? this.dataConfig[event.model.entity.type].name : '') || 'entity';
        }
        if(event.model.resultIndex >= 0) {
          array = 'resultList';
          index = event.model.resultIndex;
          label = (this.dataConfig && this.dataConfig[event.model.result.type] ? this.dataConfig[event.model.result.type].name : '') || 'result';
        }

        if(array && index >= 0) {
          this._deleteCaseIndex = event.model.caseIndex;
          this._deleteCaseDataArray = array;
          this._deleteCaseDataIndex = index;
          this._deleteCaseDataLabel = label.toLowerCase();
          this.$$('#deleteCaseDataDialog').open();
        }
      },

      /**
       * Opens the entity or result page in the given event.
       *
       * @param {Event} event
       * @private
       */
      _openPage: function(event) {
        var array = '';
        var index = -1;
        var linkFunction = null;
        var object = null;

        if(event.model.entityIndex >= 0) {
          array = 'entityList';
          index = event.model.entityIndex;
          if(array && index >= 0) {
            object = this.cases[event.model.caseIndex][array][index];
            linkFunction = (this.dataConfig && this.dataConfig[object.type] ? this.dataConfig[object.type].link : null);
          }
        }
        if(event.model.resultIndex >= 0) {
          array = 'resultList';
          index = event.model.resultIndex;
          if(array && index >= 0) {
            object = this.cases[event.model.caseIndex][array][index];
            linkFunction = this.resultLinkFunction;
          }
        }

        if(linkFunction && object.id) {
          var link = linkFunction(object.id);
          if(link) {
            // TODO Add the notification date to the link.
            this._updateNotificationDate(event.model.caseIndex, array, index);
            this._updateNotifications();
            window.open(link, '_blank');
          }
        }
      },

      /**
       * Opens the settings dialog.
       *
       * @private
       */
      _openSettingsDialog: function() {
        this.$$('#settingsDialog').open();
        if(this.profileManager && this.profileManager.reloadUser) {
          this.profileManager.reloadUser(function() {});
        }
      },

      /**
       * Runs the search in the given event by setting `searchParameters`.
       *
       * @param {Event} event
       * @private
       */
      _runSearch: function(event) {
        this.$$('#settingsDialog').close();
        this.set('processRequest', false);

        this._updateNotificationDate(event.model.caseIndex, 'searchList', event.model.searchIndex);

        this._handlingSearch = true;
        var search = this.cases[event.model.caseIndex].searchList[event.model.searchIndex];
        this.set('networkExpansionParameters', ((search.uiState ? JSON.parse(search.uiState) : {}).networkExpansion || {}));
        this.set('searchParameters', this._createSearchParameters(search.uiState, this.functionConfig, this.notificationDate));
        this.set('processRequest', true);
        this._handlingSearch = false;

        this._updateNotifications();
      },

      /**
       * Returns a `button-action` listener to save the email address in `_emailInput` as `emailAddress`.
       *
       * @return {Object}
       * @private
       */
      _saveEmailAddress: function() {
        if(this._emailInput) {
          this.set('emailAddress', this._emailInput);
        }
      },

      /**
       * Toggles `blurImages`.
       *
       * @private
       */
      _toggleBlur: function() {
        this.set('blurImages', !this.blurImages);
      },

      /**
       * Expands or collapses the case at the index in the given event.
       *
       * @param {Event} event
       * @private
       */
      _toggleCase: function(event) {
        if(this._collapsedCases.indexOf(event.model.caseIndex) < 0) {
          this.set('_collapsedCases', this._collapsedCases.map(function(item) {
            return item;
          }).concat(event.model.caseIndex));
        } else {
          this.set('_collapsedCases', this._collapsedCases.filter(function(item) {
            return item !== event.model.caseIndex;
          }).map(function(item) {
            return item;
          }));
        }
      },

      /**
       * Toggles 'sendEmailAlert` for the case in the given event.
       *
       * @param {Event} event
       * @private
       */
      _toggleEmailAlert: function(event) {
        this.set(['cases', event.model.caseIndex, 'sendEmailAlert'], !this.cases[event.model.caseIndex].sendEmailAlert);
      },

      /**
       * Updates `_emailInput` using the given email address.
       *
       * @param {String} emailAddress
       * @private
       */
      _updateEmailInput: function(emailAddress) {
        this._emailInput = emailAddress;
      },

      /**
       * Updates `notifications` by iterating over the cases and searches.
       *
       * @private
       */
      _updateNotifications: function() {
        this.notifications = this.cases.some(function(caseObject) {
          return (caseObject.entityList || []).some(function(item) {
            return item.notify;
          }) || (caseObject.resultList || []).some(function(item) {
            return item.notify;
          }) || (caseObject.searchList || []).some(function(item) {
            return item.notify;
          });
        });
      },

      /**
       * Updates the public `notificationDate` as well as the `lastViewedByUser` date and `notify` status of the object from the given array with the given index in the case with the given index.
       *
       * @param {Number} caseIndex
       * @param {String} dataArray
       * @param {Number} dataIndex
       * @private
       */
      _updateNotificationDate: function(caseIndex, dataArray, dataIndex) {
        var object = _.cloneDeep(this.cases[caseIndex][dataArray][dataIndex]);

        if(object.notify) {
          // notification queries have to be sorted in descending order so that newest
          // results are first
          object.notify = false;
          this.notificationDate = new Date(object.lastViewedByUser);
        } else {
          // if not a notification query, reset notification flags
          this._deleteNotificationDate();
        }

        object.lastViewedByUser = new Date();
        this.splice(['cases', caseIndex, dataArray], dataIndex, 1, object);
      },
    });
  })();
  </script>
</dom-module>
